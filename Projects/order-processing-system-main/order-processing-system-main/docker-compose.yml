version: '3.8'

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
  monitoring:
    driver: bridge

volumes:
  mysql_data:
  app_node_modules:
  langflow_data:
  traefik_certs:
  grafana_data:
  prometheus_data:
  letsencrypt:

services:
  # ============ MYSQL DATABASE ============
  mysql:
    build:
      context: .
      dockerfile: dockerfiles/mysql.Dockerfile
    container_name: oms-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123}
      MYSQL_DATABASE: ${DB_NAME:-order_management}
      MYSQL_USER: ${DB_USER:-oms_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-oms123}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./configs/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============ NODE.JS APPLICATION ============
  app:
    build:
      context: ./app
      dockerfile: ../dockerfiles/app.Dockerfile
    container_name: oms-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3000}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-order_management}
      DB_USER: ${DB_USER:-oms_user}
      DB_PASSWORD: ${DB_PASSWORD:-oms123}
      EVENTHUB_CONNECTION_STRING: ${EVENTHUB_CONNECTION_STRING}
      EVENTHUB_NAME: ${EVENTHUB_NAME:-orders}
      EVENTHUB_NAMESPACE: ${EVENTHUB_NAMESPACE}
    volumes:
      - ./app:/app
      - app_node_modules:/app/node_modules
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=false"

  # ============ NGINX SERVERS ============
  nginx1:
    build:
      context: .
      dockerfile: dockerfiles/nginx.Dockerfile
    container_name: oms-nginx-1
    restart: unless-stopped
    depends_on:
      - app
    environment:
      SERVER_NAME: nginx-1
      UPSTREAM_SERVICE: app
      UPSTREAM_PORT: 3000
    volumes:
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`${TRAEFIK_HOST:-oms.local}`)"
      - "traefik.http.services.app.loadbalancer.server.port=80"

  # ... (nginx2 e nginx3 similares)

  # ============ TRAEFIK LOAD BALANCER ============
  traefik:
    build:
      context: .
      dockerfile: dockerfiles/traefik.Dockerfile
    container_name: oms-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./configs/traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_certs:/letsencrypt
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${TRAEFIK_HOST:-oms.local}`)"
      - "traefik.http.routers.traefik.service=api@internal"

  # ============ PROMETHEUS (MONITORING) ============
  prometheus:
    image: prom/prometheus:latest
    container_name: oms-prometheus
    restart: unless-stopped
    volumes:
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - monitoring
    expose:
      - 9090

  # ============ GRAFANA (DASHBOARDS) ============
  grafana:
    image: grafana/grafana:latest
    container_name: oms-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./configs/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - monitoring
      - backend
    expose:
      - 3000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${TRAEFIK_HOST:-oms.local}`)"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # ============ LANGFLOW AI AGENT ============
  langflow:
    build:
      context: .
      dockerfile: dockerfiles/langflow.Dockerfile
    container_name: oms-langflow
    restart: unless-stopped
    environment:
      LANGFLOW_AUTO_LOGIN: true
      LANGFLOW_SUPERUSER: admin
      LANGFLOW_SUPERUSER_PASSWORD: ${LANGFLOW_PASSWORD:-admin123}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes:
      - langflow_data:/app/langflow
      - ./flows:/app/flows
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.langflow.rule=Host(`ai.${TRAEFIK_HOST:-oms.local}`)"
      - "traefik.http.services.langflow.loadbalancer.server.port=7860"
  
  # Adicione este servi√ßo ao seu docker-compose.yml
  web-interface:
    image: nginx:alpine
    container_name: oms-web-interface
    restart: unless-stopped
    ports:
      - "8081:80"
    volumes:
      - ./flows/interface.html:/usr/share/nginx/html/index.html:ro
      - ./flows/custom_tools.py:/usr/share/nginx/html/custom_tools.py:ro
    networks:
      - frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web-interface.rule=Host(`assistant.${TRAEFIK_HOST:-oms.local}`)"
      - "traefik.http.services.web-interface.loadbalancer.server.port=80"